<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>J.A.R.V.I.S â€” HUD Mobile Voice Assistant</title>
<link rel="icon" href="data:,">
<style>
/* =========================
   HUD THEME - Mobile first
   ========================= */
:root{
  --bg:#02060a;
  --grid:#04121a;
  --neon:#00e6ff;
  --neon-2:#22ff9f;
  --card: rgba(0,0,0,0.25);
  --glass: rgba(255,255,255,0.02);
  --muted: #7fb6c5;
  --accent: #00e6ff;
  --accent2: #22ff9f;
  --hud-padding: 14px;
  --radius: 12px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:radial-gradient(ellipse at center,#021018 0%, #000 70%); font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif; color:#cfeffd; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale}
body {overflow:hidden;}

/* grid background lines */
.hud-bg{
  position:fixed; inset:0; z-index:0;
  background-image:
    linear-gradient(rgba(0,200,255,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,200,255,0.03) 1px, transparent 1px),
    linear-gradient(0deg, rgba(255,255,255,0.02), rgba(255,255,255,0.02)),
    radial-gradient(circle at 50% 20%, rgba(0,120,140,0.03), transparent 25%);
  background-size: 18px 18px, 18px 18px, 100% 100%, 100% 100%;
}

/* main container */
.container {
  position:relative;
  width:100%;
  height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1;
  padding:22px;
}

/* central ironman silhouette area */
.holo {
  width:100%;
  max-width:820px;
  height:calc(100vh - 140px);
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
  pointer-events:none;
}

/* central ring */
.holo-ring {
  width:44vw; height:44vw;
  max-width:420px; max-height:420px;
  border-radius:50%;
  border:3px solid rgba(0,230,255,0.06);
  box-shadow:0 0 32px rgba(0,230,255,0.08), inset 0 0 30px rgba(34,255,159,0.02);
  display:flex; align-items:center; justify-content:center;
  position:relative;
  backdrop-filter: blur(2px);
}

/* rotating inner scan */
.holo-ring::before{
  content:'';
  position:absolute; inset:0; border-radius:50%;
  background: conic-gradient(from 90deg, rgba(0,230,255,0.02), rgba(34,255,159,0.02));
  mask: radial-gradient(circle at center, rgba(255,255,255,1) 45%, rgba(0,0,0,0) 46%);
  animation: spinSlow 8s linear infinite;
  pointer-events:none;
}
@keyframes spinSlow { to { transform: rotate(360deg); } }

.holo-core{
  width:36%; height:36%;
  background: radial-gradient(circle at 30% 30%, rgba(0,255,255,0.16), rgba(0,0,0,0.02));
  border-radius:50%;
  box-shadow: 0 0 36px rgba(0,230,255,0.14), inset 0 0 14px rgba(34,255,159,0.08);
  display:flex; align-items:center; justify-content:center;
  pointer-events:none;
}
.holo-core .label{
  font-size:14px; letter-spacing:4px; color:var(--neon); text-shadow: 0 0 12px rgba(0,230,255,0.6);
}

/* silhouette image - behind ring */
.holo-silhouette{
  position:absolute; width:52vw; max-width:520px; opacity:0.24; filter:contrast(140%) saturate(100%) hue-rotate(180deg);
  pointer-events:none; mix-blend-mode:screen;
}

/* corner info boxes */
.info-box {
  position:fixed; z-index:2; padding:10px 12px; border-radius:12px;
  border:1px solid rgba(0,230,255,0.14); background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
  box-shadow: 0 6px 30px rgba(0,0,0,0.6), 0 0 18px rgba(0,230,255,0.03);
  color:var(--neon); font-weight:600; letter-spacing:0.6px;
  backdrop-filter: blur(6px);
}
.info-box small{ display:block; font-size:12px; color:var(--muted); font-weight:400; margin-top:6px;}

.info-top-left{ left:12px; top:12px; }
.info-top-right{ right:12px; top:12px; text-align:right; }
.info-bottom-center{ left:50%; transform:translateX(-50%); bottom:82px; text-align:center; color:#7feaff; }

/* Start Listening big button */
.listen-btn {
  position:fixed; left:50%; transform:translateX(-50%); bottom:18px; z-index:3;
  background: linear-gradient(90deg, rgba(0,230,255,0.12), rgba(34,255,159,0.06));
  border: 2px solid rgba(0,230,255,0.3);
  color: #eaffff; font-weight:700; letter-spacing:1px;
  padding:16px 26px; border-radius:14px; box-shadow:0 10px 28px rgba(0,0,0,0.6);
  cursor:pointer; font-size:16px;
  text-shadow:0 0 8px rgba(0,230,255,0.36);
}
.listen-btn.glow { animation: pulseGlow 1.6s infinite; box-shadow: 0 10px 36px rgba(0,230,255,0.18); }
@keyframes pulseGlow {
  0%{ box-shadow:0 6px 24px rgba(0,230,255,0.12) }
  50%{ box-shadow:0 20px 56px rgba(34,255,159,0.22) }
  100%{ box-shadow:0 6px 24px rgba(0,230,255,0.12) }
}

/* small HUD message area */
.hud-msg {
  position:fixed; bottom:86px; left:50%; transform:translateX(-50%); z-index:3;
  color:#7feaff; font-family:monospace; letter-spacing:0.6px; font-size:14px;
  text-shadow:0 0 8px rgba(0,200,255,0.2);
}

/* top-left system error (thin) */
.hud-error {
  position:fixed; bottom:48px; left:50%; transform:translateX(-50%); z-index:3; color:#ff9b9b; font-weight:600;
  text-shadow: 0 0 6px rgba(255,120,120,0.18);
}

/* hidden panels (overlay modals) */
.overlay {
  position:fixed; inset:0; z-index:50; display:none; align-items:center; justify-content:center;
  background: linear-gradient(180deg, rgba(0,0,0,0.65), rgba(0,0,0,0.85));
}
.overlay .panel {
  width:92%; max-width:640px; border-radius:12px; padding:18px; background: linear-gradient(180deg, rgba(10,20,28,0.7), rgba(2,6,10,0.8));
  border:1px solid rgba(0,230,255,0.06); color:#dff9fb;
}

.overlay.flex { display:flex; }

/* camera view */
.camera-box { width:100%; height:56vh; background:#000; border-radius:8px; overflow:hidden; display:flex; align-items:center; justify-content:center; position:relative; }
.camera-box video { width:100%; height:100%; object-fit:cover; }

/* small controls inside overlays */
.btn-row{ display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
.btn { padding:8px 12px; border-radius:8px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.04); color:var(--muted); cursor:pointer; font-weight:600; }
.btn.primary{ background:linear-gradient(90deg,var(--neon),var(--neon-2)); color:#022; border:none; }

/* mem list */
.mem-list { max-height:220px; overflow:auto; margin-top:10px; background:rgba(255,255,255,0.02); border-radius:8px; padding:8px; color:#cfeffd; }

/* voice meter bottom-left */
.voice-indicator { position:fixed; left:12px; bottom:16px; z-index:3; width:160px; background:rgba(255,255,255,0.02); border-radius:8px; padding:6px; border:1px solid rgba(255,255,255,0.03); display:flex; align-items:center; gap:8px; }
.voice-bar { flex:1; height:10px; background:rgba(0,0,0,0.2); border-radius:8px; overflow:hidden; border:1px solid rgba(255,255,255,0.02); }
.voice-bar > i { display:block; height:100%; width:0%; background: linear-gradient(90deg,var(--neon),var(--neon-2)); transition:width 120ms linear; }

/* small footer credits */
.credit { position:fixed; right:12px; bottom:14px; color:var(--muted); font-size:12px; z-index:3; }

/* responsive tweaks */
@media(min-width:900px){
  .holo { height:calc(100vh - 120px); }
  .listen-btn{ bottom:30px; font-size:18px; padding:16px 30px;}
}
</style>
</head>
<body>
  <div class="hud-bg"></div>

  <!-- corner info -->
  <div class="info-box info-top-left" id="downlinkBox">
    <div style="font-size:15px">Downlink</div>
    <div style="font-size:18px; font-weight:800; margin-top:6px;" id="downlinkValue">-- Mbps</div>
    <small id="downlinkNote">Network</small>
  </div>

  <div class="info-box info-top-right" id="timeBox">
    <div style="font-size:15px">System Time</div>
    <div style="font-size:18px; font-weight:800; margin-top:6px;" id="sysTime">--:--:--</div>
    <small id="sysDate">--</small>
  </div>

  <!-- central holo -->
  <div class="container">
    <div class="holo" role="main" aria-label="Jarvis HUD">
      <!-- silhouette behind -->
      <img src="data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' width='600' height='1000'><g fill='none' stroke='%2300e6ff' stroke-opacity='0.15' stroke-width='2'><path d='M300 40 C 260 60 240 120 240 200 C240 300 260 420 240 520 C220 620 260 800 300 900' /></g></svg>" class="holo-silhouette" alt="">
      <!-- ring -->
      <div class="holo-ring" id="holoRing">
        <div class="holo-core"><div class="label">J.A.R.V.I.S</div></div>
      </div>
    </div>
  </div>

  <!-- center HUD message + error -->
  <div class="hud-msg" id="hudMsg">Say "Hey Jarvis" or press Start Listening</div>
  <div class="hud-error" id="hudError" style="display:none">Error: not-allowed. Please try again.</div>

  <!-- Start button -->
  <button class="listen-btn glow" id="btnStart">Start Listening</button>

  <!-- voice meter -->
  <div class="voice-indicator" title="Voice level">
    <div style="font-size:12px; color:var(--muted); min-width:56px">Voice</div>
    <div class="voice-bar"><i id="voiceBarInner"></i></div>
  </div>

  <div class="credit">Built by Rudransh</div>

  <!-- overlays -->
  <div id="cameraOverlay" class="overlay" aria-hidden="true">
    <div class="panel">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:800; color:var(--neon)">Camera</div>
        <div><button class="btn" id="closeCam">Close</button></div>
      </div>
      <div class="camera-box" style="margin-top:12px;">
        <video id="camVid" autoplay playsinline muted></video>
      </div>
      <div class="btn-row">
        <button class="btn primary" id="snapCam">Snap</button>
        <button class="btn" id="switchCam">Switch Camera</button>
      </div>
    </div>
  </div>

  <div id="memOverlay" class="overlay" aria-hidden="true">
    <div class="panel">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:800; color:var(--neon)">Memories</div>
        <div><button class="btn" id="closeMem">Close</button></div>
      </div>
      <div style="margin-top:10px">
        <div style="display:flex; gap:8px;">
          <input id="memText" placeholder="Remember something..." style="flex:1; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:#dff9fb"/>
          <button class="btn primary" id="memAddBtn">Add</button>
        </div>
        <div class="mem-list" id="memList" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <div id="lockOverlay" class="overlay" aria-hidden="true" style="align-items:flex-start; padding-top:16vh;">
    <div class="panel" style="max-width:480px; text-align:center;">
      <div style="font-size:22px; color:var(--neon); font-weight:800">ðŸ”’ Screen Locked</div>
      <div style="margin-top:8px; color:var(--muted)">Say "unlock screen" or press unlock</div>
      <div style="margin-top:14px"><button class="btn primary" id="unlockBtn">Unlock</button></div>
    </div>
  </div>

  <canvas id="boomCanvas" style="position:fixed; inset:0; z-index:60; display:none; pointer-events:none;"></canvas>

<script>
/* =====================================================
   Jarvis HUD â€” JS: Voice commands + UI wiring
   Mobile-first, works in Chrome/Edge on Android
   ===================================================== */

'use strict';

/* -------------------------
   Feature detection & state
   ------------------------- */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
const synth = window.speechSynthesis || null;

let recognition = null;
let listening = false;
let continuous = false;
let voiceEnabled = true;
let wakeWord = 'hey jarvis';
let wakeRequired = false;
let usingBackCamera = true;

let camStream = null;
let audioContext = null;
let analyser = null;
let meterData = null;
let reqAnim = null;

/* -------------------------
   DOM references
   ------------------------- */
const btnStart = document.getElementById('btnStart');
const hudMsg = document.getElementById('hudMsg');
const hudError = document.getElementById('hudError');
const sysTime = document.getElementById('sysTime');
const sysDate = document.getElementById('sysDate');
const downlinkValue = document.getElementById('downlinkValue');
const voiceBarInner = document.getElementById('voiceBarInner');
const holoRing = document.getElementById('holoRing');

const cameraOverlay = document.getElementById('cameraOverlay');
const camVid = document.getElementById('camVid');
const closeCam = document.getElementById('closeCam');
const snapCam = document.getElementById('snapCam');
const switchCam = document.getElementById('switchCam');

const memOverlay = document.getElementById('memOverlay');
const closeMem = document.getElementById('closeMem');
const memAddBtn = document.getElementById('memAddBtn');
const memText = document.getElementById('memText');
const memList = document.getElementById('memList');

const lockOverlay = document.getElementById('lockOverlay');
const unlockBtn = document.getElementById('unlockBtn');

const boomCanvas = document.getElementById('boomCanvas');

/* -------------------------
   Helpers
   ------------------------- */
function logUI(msg){
  hudMsg.textContent = msg;
}
function showError(msg){
  hudError.textContent = msg;
  hudError.style.display = 'block';
  setTimeout(()=> hudError.style.display = 'none', 3000);
}
function speak(text, opts = {}){
  if(!voiceEnabled || !synth) return;
  try {
    const u = new SpeechSynthesisUtterance(text);
    u.lang = opts.lang || 'en-US';
    u.rate = opts.rate || 1;
    u.pitch = opts.pitch || 1;
    synth.cancel();
    synth.speak(u);
  } catch(e) {
    console.warn('Speak failed:', e);
  }
}

/* -------------------------
   Time & network updaters
   ------------------------- */
function updateClock(){
  const now = new Date();
  sysTime.textContent = now.toLocaleTimeString();
  sysDate.textContent = now.toLocaleDateString();
}
setInterval(updateClock, 1000);
updateClock();

/* lightweight downlink estimation (measure download of small blob) */
let lastDown = '--';
async function measureDownlink(){
  try {
    const start = performance.now();
    // request a small image from a CDN (no-cache)
    const url = 'https://upload.wikimedia.org/wikipedia/commons/3/3f/Placeholder_view_vector.svg?rnd=' + Math.random();
    const r = await fetch(url, {cache:'no-store', mode:'no-cors'});
    const duration = (performance.now() - start) / 1000;
    // size unknown due to no-cors; approximate with 30KB
    const sizeKB = 30;
    const mbps = (sizeKB * 8) / (duration * 1000);
    const val = mbps < 0.01 ? '<0.01' : mbps.toFixed(2);
    downlinkValue.textContent = val + ' Mbps';
  } catch(e){
    downlinkValue.textContent = '-- Mbps';
  }
}
setInterval(measureDownlink, 7000);
measureDownlink();

/* -------------------------
   Voice meter using WebAudio
   ------------------------- */
async function startVoiceMeter(){
  try {
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return;
    if(!audioContext){
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true, video:false });
    const src = audioContext.createMediaStreamSource(stream);
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 256;
    src.connect(analyser);
    const bufferLen = analyser.frequencyBinCount;
    meterData = new Uint8Array(bufferLen);
    function loop(){
      analyser.getByteFrequencyData(meterData);
      let sum = 0;
      for(let i=0;i<meterData.length;i++){ sum += meterData[i]; }
      const avg = sum / meterData.length;
      const pct = Math.min(100, Math.round((avg / 255) * 100));
      voiceBarInner.style.width = pct + '%';
      // small holo ring reaction
      holoRing.style.transform = `scale(${1 + pct/220})`;
      reqAnim = requestAnimationFrame(loop);
    }
    reqAnim = requestAnimationFrame(loop);
    // stop saved stream on stopVoiceMeter
    startVoiceMeter._stream = stream;
  } catch(e){
    // ignore meter errors
  }
}
function stopVoiceMeter(){
  if(reqAnim) cancelAnimationFrame(reqAnim);
  reqAnim = null;
  voiceBarInner.style.width = '0%';
  holoRing.style.transform = '';
  if(startVoiceMeter._stream){
    startVoiceMeter._stream.getTracks().forEach(t=>t.stop());
    startVoiceMeter._stream = null;
  }
  if(analyser){ analyser.disconnect(); analyser = null; }
}

/* -------------------------
   Recognition setup
   ------------------------- */
function setupRecognition(){
  if(!SpeechRecognition){
    logUI('SpeechRecognition not supported. Use Chrome.');
    btnStart.disabled = true;
    return;
  }
  recognition = new SpeechRecognition();
  recognition.lang = 'en-US';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  recognition.continuous = continuous;

  recognition.onstart = () => {
    listening = true;
    btnStart.classList.add('glow');
    btnStart.textContent = 'Listening...';
    logUI('Listening â€” speak now');
    startVoiceMeter();
  };
  recognition.onend = () => {
    listening = false;
    btnStart.classList.remove('glow');
    btnStart.textContent = 'Start Listening';
    logUI('Idle');
    stopVoiceMeter();
    // if continuous mode, restart quickly
    if(continuous && recognition) {
      setTimeout(()=> {
        try { recognition.start(); } catch(e){}
      }, 300);
    }
  };
  recognition.onerror = (ev) => {
    console.warn('rec error', ev);
    stopVoiceMeter();
    showError('Voice error: ' + (ev.error || 'unknown'));
    if(ev.error === 'not-allowed' || ev.error === 'service-not-allowed') {
      hudMsg.textContent = 'Microphone permission blocked. Allow microphone in site settings.';
      speak('Microphone permission blocked, please allow it.');
    }
  };
  recognition.onresult = (ev) => {
    const res = ev.results[ev.results.length-1][0].transcript.trim();
    handleHeard(res);
  };
}

/* -------------------------
   Command handling
   ------------------------- */
function handleHeard(textRaw){
  const text = textRaw.trim();
  logUI('Heard: ' + text);
  // quick UI echo
  flashHUDMessage('"' + text + '"');

  const lower = text.toLowerCase();

  // wake-word handling
  if(wakeRequired){
    if(!lower.includes(wakeWord) && !lower.includes('hey jarvis') && !lower.includes('ok jarvis')){
      logUI('Ignored (wake word required)');
      return;
    }
    // strip wake words
    textCmd = lower.replace(wakeWord, '').replace('hey jarvis','').replace('ok jarvis','').trim();
  } else {
    var textCmd = lower;
    // if wake-word present remove it
    textCmd = textCmd.replace(wakeWord, '').replace('hey jarvis','').replace('ok jarvis','').trim();
  }

  // handle simple conversation
  if(/^hi\b|^hello\b|^hey\b/.test(textCmd)){
    speak('Hello boss. Ready for commands.');
    return;
  }

  // time/date
  if(textCmd.includes('time')){
    const now = new Date();
    const out = 'It is ' + now.toLocaleTimeString();
    speak(out); logUI(out); return;
  }
  if(textCmd.includes('date')){
    const now = new Date();
    const out = 'Today is ' + now.toLocaleDateString();
    speak(out); logUI(out); return;
  }

  // open websites
  if(/\bopen (youtube|google|wikipedia|github|spotify|maps|whatsapp)\b/.test(textCmd)){
    if(textCmd.includes('youtube')) { speak('Opening YouTube'); window.open('https://youtube.com', '_blank'); return; }
    if(textCmd.includes('google')) { speak('Opening Google'); window.open('https://google.com', '_blank'); return; }
    if(textCmd.includes('wikipedia')) { speak('Opening Wikipedia'); window.open('https://wikipedia.org', '_blank'); return; }
    if(textCmd.includes('github')) { speak('Opening GitHub'); window.open('https://github.com', '_blank'); return; }
    if(textCmd.includes('spotify')) { speak('Opening Spotify'); window.open('https://open.spotify.com', '_blank'); return; }
    if(textCmd.includes('maps')) { speak('Opening Maps'); window.open('https://maps.google.com', '_blank'); return; }
    if(textCmd.includes('whatsapp')) { speak('Opening WhatsApp'); openWhatsApp(); return; }
  }

  // search
  if(textCmd.startsWith('search ') || textCmd.startsWith('google ')){
    const q = textCmd.replace(/^(search|google)\s+/,'').trim();
    if(!q){ speak('What should I search?'); return; }
    speak('Searching for ' + q);
    window.open('https://www.google.com/search?q=' + encodeURIComponent(q), '_blank');
    return;
  }

  // wikipedia summary
  if(textCmd.startsWith('wiki ') || textCmd.startsWith('wikipedia ')){
    const term = textCmd.replace(/^(wiki|wikipedia)\s+/,'').trim();
    if(!term) { speak('What should I look up on Wikipedia?'); return; }
    speak('Looking up ' + term);
    fetch('https://en.wikipedia.org/api/rest_v1/page/summary/' + encodeURIComponent(term))
      .then(r=>r.json()).then(j=>{
        const ex = j.extract ? j.extract.split('. ').slice(0,2).join('. ') + '.' : 'No summary found.';
        speak(ex);
      }).catch(e=>{
        speak('Failed to fetch Wikipedia.');
      });
    return;
  }

  // calculate expressions simple
  if(textCmd.match(/^(calculate|what is) /) || /^[0-9\+\-\*\/\.\s\(\)]+$/.test(textCmd)){
    const expr = textCmd.replace(/^(calculate|what is)\s+/,'').replace(/[^0-9+\-*/(). %]/g,'');
    if(!expr){ speak('Cannot parse expression'); return; }
    try {
      const val = Function('"use strict";return (' + expr + ')')();
      speak('Result is ' + val);
    } catch(e){ speak('I could not calculate that'); }
    return;
  }

  // timer
  if(textCmd.startsWith('set timer') || textCmd.includes('timer')){
    const m = textCmd.match(/(\d+)\s*(seconds|second|minutes|minute|mins|secs)?/);
    if(!m){ speak('Please specify duration in seconds or minutes'); return; }
    let num = parseInt(m[1],10);
    let unit = (m[2]||'seconds');
    let ms = unit.startsWith('min') ? num*60000 : num*1000;
    speak('Timer set for ' + num + ' ' + unit);
    setTimeout(()=> {
      speak('Timer finished: ' + num + ' ' + unit);
      alert('Timer finished: ' + num + ' ' + unit);
    }, ms);
    return;
  }

  // screenshot
  if(textCmd.includes('screenshot') || textCmd.includes('capture screen')){
    takeScreenshot();
    return;
  }

  // camera controls
  if(textCmd.includes('open camera') || textCmd.includes('show camera')){
    openCameraOverlay(); return;
  }
  if(textCmd.includes('close camera') || textCmd.includes('hide camera')){
    closeCameraOverlay(); return;
  }

  // flashlight
  if(textCmd.includes('flashlight on') || textCmd.includes('torch on')){
    flashlight(true); return;
  }
  if(textCmd.includes('flashlight off') || textCmd.includes('torch off')){
    flashlight(false); return;
  }

  // power animations
  if(textCmd.includes('power off') || textCmd.includes('shutdown')){
    powerOffSim(); return;
  }
  if(textCmd.includes('restart')){
    restartSim(); return;
  }

  // lock/unlock UI
  if(textCmd.includes('lock screen')){
    lockScreen(); return;
  }
  if(textCmd.includes('unlock screen')){
    unlockScreen(); return;
  }

  // memories
  if(textCmd.startsWith('remember ')){
    const mem = textCmd.replace(/^remember\s+/,'').trim();
    if(!mem){ speak('What should I remember?'); return; }
    addMemory(mem);
    speak('Saved.');
    return;
  }
  if(textCmd.includes('what do you remember') || textCmd.includes('list memories')){
    openMemories(); return;
  }

  // games
  if(textCmd.includes('rock') && textCmd.includes('paper') && textCmd.includes('scissors')){
    playRPS(); return;
  }
  if(textCmd.includes('guess number')){
    playGuess(); return;
  }

  // jokes & quotes
  if(textCmd.includes('joke')){
    const jokes = ["Why did the developer go broke? He used all his cache.","Why programmers prefer dark mode? The light attracts bugs."];
    speak(jokes[Math.floor(Math.random()*jokes.length)]); return;
  }
  if(textCmd.includes('motivate') || textCmd.includes('quote')){
    const quotes = ["The best time to start is now.","Keep going â€” do not stop."];
    speak(quotes[Math.floor(Math.random()*quotes.length)]); return;
  }

  // fallback: ask to search
  speak('I did not understand. Shall I search the web for ' + text + '?');
  setTimeout(()=> {
    if(confirm('Search web for "'+text+'" ?')) window.open('https://www.google.com/search?q=' + encodeURIComponent(text), '_blank');
  }, 800);
}

/* -------------------------
   HUD & small UI helpers
   ------------------------- */
function flashHUDMessage(text, ms=2200){
  hudMsg.textContent = text;
  setTimeout(()=> hudMsg.textContent = 'Say "Hey Jarvis" or press Start Listening', ms);
}

/* -------------------------
   Start / Stop listening
   ------------------------- */
btnStart.addEventListener('click', async ()=>{
  if(!recognition) setupRecognition();
  // If not listening -> start, else stop
  if(!listening){
    try {
      await requestMicrophonePermission();
      recognition.start();
    } catch(e){
      console.warn('start error', e);
      showError('Microphone permission blocked or error');
    }
  } else {
    try { recognition.stop(); } catch(e){}
  }
});

async function requestMicrophonePermission(){
  // simple try-getMedia to force prompt
  try {
    await navigator.mediaDevices.getUserMedia({ audio:true });
    return true;
  } catch(e){
    throw e;
  }
}

/* -------------------------
   Camera overlay functions
   ------------------------- */
async function openCameraOverlay(){
  cameraOverlay.classList.add('flex');
  cameraOverlay.setAttribute('aria-hidden','false');
  try {
    if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream = null; }
    camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: usingBackCamera ? 'environment' : 'user' }, audio:false });
    camVid.srcObject = camStream;
    await camVid.play();
  } catch(e){
    console.warn('camera error', e);
    showError('Camera permission denied or device error');
    cameraOverlay.classList.remove('flex');
  }
}
function closeCameraOverlay(){
  cameraOverlay.classList.remove('flex');
  cameraOverlay.setAttribute('aria-hidden','true');
  if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream = null; camVid.srcObject = null; }
}
closeCam.addEventListener('click', closeCameraOverlay);

snapCam.addEventListener('click', ()=>{
  if(!camStream) return;
  const v = camVid;
  const c = document.createElement('canvas');
  c.width = v.videoWidth || 800;
  c.height = v.videoHeight || 600;
  c.getContext('2d').drawImage(v,0,0,c.width,c.height);
  const url = c.toDataURL('image/png');
  const a = document.createElement('a'); a.href = url; a.download = 'jarvis-snap.png'; a.click();
  speak('Snapshot saved');
});

switchCam.addEventListener('click', async ()=>{
  usingBackCamera = !usingBackCamera;
  if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream = null; }
  await openCameraOverlay();
});

/* -------------------------
   Flashlight (screen white) fallback
   ------------------------- */
let torchOn = false;
function flashlight(on){
  // mobile browsers don't allow real flashlight via JS; simulate with white overlay
  if(on){
    if(!document.getElementById('flashSim')){
      const d = document.createElement('div'); d.id = 'flashSim';
      d.style.position='fixed'; d.style.inset='0'; d.style.zIndex='70'; d.style.background='#fff'; d.style.opacity='1';
      document.body.appendChild(d);
    } else {
      document.getElementById('flashSim').style.display='block';
    }
    torchOn = true;
    speak('Flashlight on');
  } else {
    const el = document.getElementById('flashSim'); if(el) el.style.display='none';
    torchOn = false; speak('Flashlight off');
  }
}

/* -------------------------
   Self destruct canvas animation
   ------------------------- */
function runSelfDestruct(){
  const c = boomCanvas;
  const ctx = c.getContext('2d');
  c.width = innerWidth; c.height = innerHeight;
  c.style.display = 'block';
  const particles = [];
  for(let i=0;i<260;i++){
    particles.push({
      x: innerWidth/2 + (Math.random()-0.5)*160,
      y: innerHeight/2 + (Math.random()-0.5)*160,
      vx: (Math.random()-0.5)*12,
      vy: (Math.random()-1)*12 - 2,
      r: Math.random()*4+1,
      life: Math.random()*120 + 40,
      color: `rgba(${200+Math.floor(Math.random()*55)},${Math.floor(Math.random()*140)},0,`
    });
  }
  let t=0;
  speak('Self destruct in 3, 2, 1');
  const id = setInterval(()=>{
    ctx.fillStyle = 'rgba(0,0,0,0.12)'; ctx.fillRect(0,0,c.width,c.height);
    particles.forEach(p=>{
      p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.life--;
      ctx.beginPath(); ctx.fillStyle = p.color + (p.life/160) + ')'; ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
    });
    t++;
    if(t%6===0) document.body.style.transform = `translate(${(Math.random()-0.5)*8}px, ${(Math.random()-0.5)*8}px)`;
    if(t>180){ clearInterval(id); ctx.clearRect(0,0,c.width,c.height); c.style.display='none'; document.body.style.transform=''; }
  }, 16);
}

/* -------------------------
   Power simulations
   ------------------------- */
function powerOffSim(){
  speak('Shutting down');
  document.body.style.transition = 'filter 0.8s';
  setTimeout(()=> document.body.style.filter = 'brightness(0.02)', 600);
}
function restartSim(){
  speak('Restarting');
  document.body.style.transition = 'filter 0.8s';
  setTimeout(()=> document.body.style.filter = 'brightness(0.02)', 600);
  setTimeout(()=> { document.body.style.filter=''; speak('Restart complete'); }, 2800);
}

/* -------------------------
   Lock/unlock UI
   ------------------------- */
function lockScreen(){
  lockOverlay.classList.add('flex');
  lockOverlay.setAttribute('aria-hidden','false');
  speak('Screen locked');
}
function unlockScreen(){
  lockOverlay.classList.remove('flex');
  lockOverlay.setAttribute('aria-hidden','true');
  speak('Unlocked');
}
unlockBtn.addEventListener('click', unlockScreen);

/* -------------------------
   Memories storage & UI
   ------------------------- */
function loadMemories(){
  try {
    return JSON.parse(localStorage.getItem('jarvis_mems') || '[]');
  } catch(e){ return []; }
}
function saveMemories(a){
  localStorage.setItem('jarvis_mems', JSON.stringify(a));
}
function renderMemories(){
  const mems = loadMemories();
  memList.innerHTML = '';
  if(mems.length === 0){
    memList.innerHTML = '<div style="color:var(--muted);">No memories</div>';
    return;
  }
  mems.slice().reverse().forEach((m, idx)=>{
    const wrap = document.createElement('div');
    wrap.style.padding = '8px'; wrap.style.borderBottom = '1px dashed rgba(255,255,255,0.02)';
    wrap.innerHTML = `<div style="font-size:12px;color:var(--muted)">${new Date(m.time).toLocaleString()}</div><div style="margin-top:6px">${escapeHtml(m.text)}</div><div style="margin-top:6px"><button class="btn" data-idx="${mems.length-1-idx}">Delete</button></div>`;
    memList.appendChild(wrap);
  });
  memList.querySelectorAll('button').forEach(b=>{
    b.addEventListener('click', ()=>{
      const i = parseInt(b.getAttribute('data-idx'),10);
      const arr = loadMemories(); arr.splice(i,1); saveMemories(arr); renderMemories(); speak('Memory deleted');
    });
  });
}
function addMemory(text){
  const arr = loadMemories();
  arr.push({ text: text, time: Date.now() });
  saveMemories(arr);
  renderMemories();
}
memAddBtn.addEventListener('click', ()=>{
  const t = memText.value.trim(); if(!t) return; addMemory(t); memText.value=''; speak('Memory added');
});

/* open memories overlay */
function openMemories(){ memOverlay.classList.add('flex'); memOverlay.setAttribute('aria-hidden','false'); renderMemories(); }
closeMem.addEventListener('click', ()=> { memOverlay.classList.remove('flex'); memOverlay.setAttribute('aria-hidden','true'); });

/* -------------------------
   Screenshot (html2canvas dynamic)
   ------------------------- */
async function takeScreenshot(){
  // prefer html2canvas if available, otherwise try to use toDataURL of body (not reliable)
  if(typeof html2canvas === 'undefined'){
    try {
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
    } catch(e){
      showError('Failed to load screenshot helper');
      return;
    }
  }
  speak('Taking screenshot');
  try {
    const node = document.documentElement;
    const canvas = await html2canvas(node, {useCORS:true, logging:false, scale:1});
    const url = canvas.toDataURL('image/png');
    const a = document.createElement('a'); a.href = url; a.download = 'jarvis-screenshot.png'; a.click();
    speak('Saved screenshot');
  } catch(e){
    showError('Screenshot failed');
  }
}

/* small dynamic script loader */
function loadScript(src){
  return new Promise((res, rej)=>{
    const s = document.createElement('script'); s.src = src; s.onload = ()=>res(); s.onerror = ()=>rej(new Error('Failed to load ' + src));
    document.head.appendChild(s);
  });
}

/* -------------------------
   WhatsApp / gallery helpers
   ------------------------- */
function openWhatsApp(){
  try { window.location.href = "intent://send/#Intent;scheme=whatsapp;package=com.whatsapp;end"; setTimeout(()=> window.open('https://web.whatsapp.com', '_blank'), 600); } catch(e){ window.open('https://web.whatsapp.com', '_blank'); }
}
function openGallery(){ window.open('https://photos.google.com', '_blank'); }

/* -------------------------
   Mini games
   ------------------------- */
function playRPS(){
  const choices = ['rock','paper','scissors'];
  const user = prompt('Choose rock, paper or scissors:');
  if(!user) return;
  const u = user.toLowerCase();
  if(!choices.includes(u)){ alert('Invalid'); return; }
  const bot = choices[Math.floor(Math.random()*3)];
  let res='Draw';
  if((u==='rock'&&bot==='scissors')||(u==='paper'&&bot==='rock')||(u==='scissors'&&bot==='paper')) res='You win!';
  else if(u===bot) res='Draw';
  else res='You lose!';
  speak(`You chose ${u}. I chose ${bot}. ${res}`);
  alert(`You: ${u}\nJarvis: ${bot}\n\n${res}`);
}
function playGuess(){
  const target = Math.floor(Math.random()*50)+1;
  let tries=0; let ok=false;
  while(tries<7){
    const g = prompt('Guess (1-50). Attempts left: ' + (7-tries));
    if(g===null) return;
    const n = parseInt(g,10);
    if(isNaN(n)){ alert('Enter a number'); continue; }
    tries++;
    if(n===target){ speak('Correct'); alert('Correct!'); ok=true; break; }
    else if(n<target){ speak('Higher'); alert('Higher'); }
    else { speak('Lower'); alert('Lower'); }
  }
  if(!ok){ speak('Out of attempts. The number was ' + target); alert('Out of attempts. The number was ' + target); }
}

/* -------------------------
   Utility: escape HTML
   ------------------------- */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

/* -------------------------
   Init
   ------------------------- */
function init(){
  // set initial labels
  hudMsg.textContent = 'Say "Hey Jarvis" or press Start Listening';
  // set custom wake word from local storage if provided
  try {
    const w = localStorage.getItem('jarvis_wake'); if(w) wakeWord = w;
  } catch(e){}
  // set event listeners for overlays toggles (shortcuts)
  // long-press center ring to open memories? (touch-friendly)
  holoRing.addEventListener('click', ()=> { openMemories(); });
  // keyboard accessibility (Enter to start)
  document.addEventListener('keydown', (e)=> { if(e.key === 'Enter') btnStart.click(); });

  // prepare recognition object
  setupRecognition();

  // click on central button to show start
  btnStart.title = 'Start Listening';
  // quick long-press to toggle wake requirement
  let pressTimer = null;
  btnStart.addEventListener('touchstart', (e)=> {
    pressTimer = setTimeout(()=> {
      wakeRequired = !wakeRequired;
      speak(wakeRequired ? 'Wake word required' : 'Wake word not required');
      flashHUDMessage('Wake required: ' + (wakeRequired?'Yes':'No'), 2000);
    }, 800);
  });
  btnStart.addEventListener('touchend', ()=> { if(pressTimer) clearTimeout(pressTimer); });

  // wire additional small controls for demo
  // camera overlay controls wired earlier

  // initial memory render
  renderMemories();

  // log ready
  console.log('Jarvis HUD ready');
  speak('Jarvis ready');
}
window.addEventListener('load', ()=> {
  init();
  // request audio context resume on user gesture for some mobile browsers
  document.body.addEventListener('touchstart', ()=> {
    if(audioContext && audioContext.state === 'suspended') audioContext.resume();
  }, { once:true });
});
</script>
</body>
</html>
